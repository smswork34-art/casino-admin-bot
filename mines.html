<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ORANGEW1N ‚Äî MINES</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #FF6B00;
            --primary-dark: #FF4500;
            --primary-light: #FF8C00;
            --secondary: #00C2FF;
            --success: #00C853;
            --danger: #FF3D00;
            --warning: #FF9800;
            --bg-dark: #0A0A0A;
            --bg-card: #111111;
            --bg-sidebar: #0D0D0D;
            --bg-header: #0A0A0A;
            --text-primary: #FFFFFF;
            --text-secondary: #9B9B9B;
            --border: #252525;
            --gradient: linear-gradient(135deg, #FF6B00, #FF4500);
            --gradient-blue: linear-gradient(135deg, #00C2FF, #0088CC);
            --bottom-nav: #0D0D0D;
            --card-bg: #1A1A1A;
            --gem-gradient: linear-gradient(135deg, #00C2FF, #0088CC);
            --mine-gradient: linear-gradient(135deg, #FF3D00, #CC0000);
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .app {
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
            position: relative;
            background: var(--bg-dark);
            border-radius: 24px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
        }


        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-dark);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .logo-mini {
            font-size: 20px;
            font-weight: 900;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 0.5px;
            cursor: pointer;
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .balance-chip {
            background: var(--card-bg);
            border-radius: 100px;
            padding: 8px 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--border);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
        }

        .balance-chip i {
            color: var(--primary);
            font-size: 14px;
        }

        .avatar-btn {
            width: 42px;
            height: 42px;
            background: var(--gradient);
            border-radius: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

      
        .game-content {
            padding: 20px 16px;
            background: var(--bg-dark);
        }

        .game-title {
            font-size: 24px;
            font-weight: 900;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            text-align: center;
        }

        .game-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-container {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            flex: 1;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .stat-value {
            font-size: 22px;
            font-weight: 900;
            margin-bottom: 5px;
        }

        .stat-value.multiplier {
            color: var(--success);
            text-shadow: 0 0 10px rgba(0,200,83,0.3);
        }

        .stat-value.mines {
            color: var(--danger);
            text-shadow: 0 0 10px rgba(255,61,0,0.3);
        }

        .stat-value.bet {
            color: var(--primary);
            text-shadow: 0 0 10px rgba(255,107,0,0.3);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
        }

        .mines-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .mines-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin: 0 auto;
            width: 100%;
            max-width: 400px;
        }

        .cell {
            aspect-ratio: 1;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 26px;
            font-weight: 900;
            min-width: 60px;
            min-height: 60px;
            position: relative;
            color: var(--text-secondary);
        }

        .cell:hover:not(.revealed):not(.exploded) {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(255,107,0,0.3);
        }

        .cell.revealed {
            cursor: default;
        }

        .cell.revealed.gem {
            background: var(--gem-gradient);
            border-color: var(--secondary);
            color: white;
        }

        .cell.revealed.mine {
            background: var(--mine-gradient);
            border-color: var(--danger);
            color: white;
        }

        .cell.exploded {
            animation: explode 0.5s ease-out;
            background: var(--mine-gradient);
            border-color: var(--danger);
            color: white;
        }

        .cell-bonus {
            position: absolute;
            top: -12px;
            right: -12px;
            background: var(--success);
            color: white;
            font-size: 12px;
            font-weight: 900;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bonusAppear 0.4s ease-out;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 2px solid var(--bg-dark);
        }

        @keyframes bonusAppear {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes explode {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .bet-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .section-title {
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .bet-label {
            display: block;
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .amount-input-container {
            display: flex;
            align-items: center;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 4px;
            transition: all 0.2s;
        }

        .amount-input-container:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255,107,0,0.2);
        }

        .amount-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            padding: 12px 16px;
            outline: none;
            font-weight: 700;
        }

        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .quick-amount {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 5px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .quick-amount:hover {
            background: rgba(255,107,0,0.1);
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .mines-selector {
            margin-bottom: 20px;
        }

        .mines-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .mine-count-btn {
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px 5px;
            text-align: center;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .mine-count-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .mine-count-btn.selected {
            background: var(--mine-gradient);
            border-color: var(--danger);
            color: white;
        }

        .game-controls {
            display: flex;
            gap: 12px;
        }

        .game-button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 800;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .start-button {
            background: var(--gradient);
            color: white;
        }

        .start-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,107,0,0.4);
        }

        .cashout-button {
            background: var(--gem-gradient);
            color: white;
        }

        .cashout-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,194,255,0.4);
        }

        .game-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .history-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .history-list {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 4px;
            min-height: 56px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--border);
        }

        .history-list::-webkit-scrollbar {
            height: 4px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .history-item {
            min-width: 70px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            flex-shrink: 0;
            gap: 6px;
        }

        .history-win {
            background: rgba(0,200,83,0.1);
            color: var(--success);
            border: 1px solid rgba(0,200,83,0.3);
        }

        .history-lose {
            background: rgba(255,61,0,0.1);
            color: var(--danger);
            border: 1px solid rgba(255,61,0,0.3);
        }

        .win-amount {
            color: var(--success);
            font-size: 12px;
        }

        .lose-amount {
            color: var(--danger);
            font-size: 12px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

      
        .profile-menu {
            position: fixed;
            top: 70px;
            right: 16px;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            width: 300px;
            max-width: calc(100vw - 32px);
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            z-index: 1001;
            display: none;
        }

        .profile-menu.active {
            display: block;
            animation: fadeIn 0.2s;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            z-index: 998;
            display: none;
        }

        .menu-overlay.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification {
            position: fixed;
            top: 70px;
            right: 15px;
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 12px 15px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            z-index: 1000;
            max-width: calc(100vw - 30px);
            transform: translateX(400px);
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }

        .notification.show { transform: translateX(0); }

        @media (max-width: 480px) {
            .mines-grid {
                gap: 10px;
            }
            .cell {
                min-width: 52px;
                min-height: 52px;
                font-size: 22px;
            }
            .stats-container {
                gap: 10px;
            }
            .stat-box {
                padding: 12px 8px;
            }
            .stat-value {
                font-size: 20px;
            }
            .mines-buttons {
                grid-template-columns: repeat(5, 1fr);
                gap: 6px;
            }
            .mine-count-btn {
                padding: 10px 3px;
                font-size: 13px;
            }
        }

        @media (max-width: 400px) {
            .cell {
                min-width: 48px;
                min-height: 48px;
                font-size: 20px;
            }
            .mines-section {
                padding: 20px;
            }
            .game-controls {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
    
        <div class="top-bar">
            <div class="logo-mini" onclick="window.location.href='index.html'">ORANGEW1N</div>
            <div class="top-actions">
                <div class="balance-chip" id="balanceChip">
                    <i class="fas fa-coins"></i>
                    <span class="balance-number" id="mainBalance">0</span> ‚ÇΩ
                </div>
                <div class="avatar-btn" id="avatarBtn">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>

      
        <div class="game-content">
            <h1 class="game-title">üí£ MINES</h1>
            <p class="game-subtitle">–ù–∞–π–¥–∏—Ç–µ –∞–ª–º–∞–∑—ã –∏ –∏–∑–±–µ–≥–∞–π—Ç–µ –º–∏–Ω!</p>
            
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-value multiplier" id="currentMultiplier">1.00x</div>
                    <div class="stat-label">–ú–ù–û–ñ–ò–¢–ï–õ–¨</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value mines" id="currentMines">3</div>
                    <div class="stat-label">–ú–ò–ù–´</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value bet" id="currentBet">100</div>
                    <div class="stat-label">–°–¢–ê–í–ö–ê</div>
                </div>
            </div>
            
            <div class="mines-section">
                <div class="mines-grid" id="minesGrid"></div>
            </div>
            
            <div class="bet-section">
                <div class="bet-amount">
                    <label class="bet-label">–°–£–ú–ú–ê –°–¢–ê–í–ö–ò (‚ÇΩ)</label>
                    <div class="amount-input-container">
                        <input type="number" id="betAmount" class="amount-input" value="100" min="1">
                    </div>
                    
                    <div class="quick-amounts">
                        <div class="quick-amount" data-amount="50">50 ‚ÇΩ</div>
                        <div class="quick-amount" data-amount="100">100 ‚ÇΩ</div>
                        <div class="quick-amount" data-amount="500">500 ‚ÇΩ</div>
                        <div class="quick-amount" data-amount="1000">1000 ‚ÇΩ</div>
                        <div class="quick-amount" id="halfBalance">¬Ω –±–∞–ª–∞–Ω—Å–∞</div>
                        <div class="quick-amount" id="maxBalance">–ú–ê–ö–°</div>
                    </div>
                </div>
                
                <div class="mines-selector">
                    <label class="bet-label">–ö–û–õ–ò–ß–ï–°–¢–í–û –ú–ò–ù (3-24)</label>
                    <div class="mines-buttons" id="minesButtons">
                        <div class="mine-count-btn" data-mines="3">3</div>
                        <div class="mine-count-btn" data-mines="5">5</div>
                        <div class="mine-count-btn" data-mines="8">8</div>
                        <div class="mine-count-btn" data-mines="10">10</div>
                        <div class="mine-count-btn" data-mines="12">12</div>
                        <div class="mine-count-btn" data-mines="15">15</div>
                        <div class="mine-count-btn" data-mines="18">18</div>
                        <div class="mine-count-btn" data-mines="20">20</div>
                        <div class="mine-count-btn" data-mines="22">22</div>
                        <div class="mine-count-btn selected" data-mines="24">24</div>
                    </div>
                </div>
                
                <div class="game-controls">
                    <button class="game-button start-button" id="startButton">
                        <i class="fas fa-play"></i>
                        –ù–ê–ß–ê–¢–¨
                    </button>
                    <button class="game-button cashout-button" id="cashoutButton" disabled>
                        <i class="fas fa-money-bill-wave"></i>
                        –ó–ê–ë–†–ê–¢–¨
                    </button>
                </div>
            </div>
            
            <div class="history-section">
                <div class="section-title">–ü–û–°–õ–ï–î–ù–ò–ï –ò–ì–†–´</div>
                <div class="history-list" id="historyList"></div>
            </div>
        </div>
    </div>

  
    <div class="menu-overlay" id="menuOverlay"></div>
    <div class="profile-menu" id="profileMenu">
        <div class="profile-header" style="display:flex; align-items:center; gap:12px; margin-bottom:15px; padding-bottom:12px; border-bottom:1px solid var(--border);">
            <div style="width:50px; height:50px; background:var(--gradient); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:22px;">
                <i class="fas fa-user"></i>
            </div>
            <div>
                <h3 id="profileUsername" style="font-size:16px; margin-bottom:3px;">–ì–æ—Å—Ç—å</h3>
                <p id="profileUserId" style="color:var(--text-secondary); font-size:12px;">ID: –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</p>
            </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:15px;">
            <div style="background:var(--bg-dark); padding:12px; border-radius:12px; text-align:center;">
                <div style="font-size:16px; font-weight:800; color:var(--primary); margin-bottom:3px;" id="profileBalance">0 ‚ÇΩ</div>
                <div style="color:var(--text-secondary); font-size:11px;">–ë–∞–ª–∞–Ω—Å</div>
            </div>
            <div style="background:var(--bg-dark); padding:12px; border-radius:12px; text-align:center;">
                <div style="font-size:16px; font-weight:800; color:var(--primary); margin-bottom:3px;" id="profileWins">0</div>
                <div style="color:var(--text-secondary); font-size:11px;">–ü–æ–±–µ–¥</div>
            </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:8px;">
            <button onclick="window.depositModal?.()" style="padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:12px; color:white; display:flex; align-items:center; gap:8px; font-weight:600; cursor:pointer; width:100%;"><i class="fas fa-wallet"></i> –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            <button onclick="window.withdrawalModal?.()" style="padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:12px; color:white; display:flex; align-items:center; gap:8px; font-weight:600; cursor:pointer; width:100%;"><i class="fas fa-money-bill-wave"></i> –í—ã–≤–µ—Å—Ç–∏</button>
            <button onclick="window.open('https://t.me/orangew1nsupport', '_blank')" style="padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:12px; color:white; display:flex; align-items:center; gap:8px; font-weight:600; cursor:pointer; width:100%;"><i class="fas fa-headset"></i> –ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
        </div>
    </div>

    <script>
       
        const SUPABASE_URL = 'https://lllmhsatptxscjjoluov.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsbG1oc2F0cHR4c2Nqam9sdW92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMjQ3NTksImV4cCI6MjA4NTkwMDc1OX0.wtzQkF54-HdALvDixNADLwoVqdw7AIPSOM4hmBISQ8U';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
     
        let currentBalance = 0;
        let currentBetAmount = 100;
        let selectedMinesCount = 24;
        let userId = null;
        let gameHistory = [];
        
        let gameActive = false;
        let minesPositions = [];
        let revealedCells = [];
        let currentMultiplier = 1.0;
        let gameId = null;
        let winsCount = 0;
        
      
        const baseMultipliersByMines = {
            3: 1.20, 5: 1.50, 8: 1.80, 10: 2.00,
            12: 2.50, 15: 3.00, 18: 3.50, 20: 4.00,
            22: 4.50, 24: 5.00
        };
        
        const cellBonusMultipliers = {
            3: 0.08, 5: 0.10, 8: 0.12, 10: 0.15,
            12: 0.18, 15: 0.22, 18: 0.26, 20: 0.30,
            22: 0.35, 24: 0.40
        };
        
     
        let lossStreak = 0;
        let gamesPlayed = 0;
        const MAX_LOSS_STREAK = 4;
        const LOSS_BOOST = 0.18;
        
   
        const balanceEl = document.getElementById('mainBalance');
        const profileBalanceEl = document.getElementById('profileBalance');
        const profileWinsEl = document.getElementById('profileWins');
        const betAmountInput = document.getElementById('betAmount');
        const startButton = document.getElementById('startButton');
        const cashoutButton = document.getElementById('cashoutButton');
        const minesGrid = document.getElementById('minesGrid');
        const historyList = document.getElementById('historyList');
        const currentMultiplierEl = document.getElementById('currentMultiplier');
        const currentMinesEl = document.getElementById('currentMines');
        const currentBetEl = document.getElementById('currentBet');
        
     
        function initGame() {
            userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                localStorage.setItem('user_id', userId);
                localStorage.setItem('username', '–ò–≥—Ä–æ–∫');
            }
            
            const savedBalance = localStorage.getItem('user_balance');
            currentBalance = savedBalance ? parseInt(savedBalance) : 15780;
            localStorage.setItem('user_balance', currentBalance);
            
            const savedWins = localStorage.getItem('mines_wins');
            winsCount = savedWins ? parseInt(savedWins) : 0;
            
            loadStats();
            createGrid();
            loadHistory();
            setupEventListeners();
            updateBalanceDisplay();
            updateCurrentSettings();
            updateProfileInfo();
            
            profileWinsEl.textContent = winsCount;
        }
        
        function loadStats() {
            const stats = localStorage.getItem('mines_stats');
            if (stats) {
                try {
                    const parsed = JSON.parse(stats);
                    lossStreak = parsed.lossStreak || 0;
                    gamesPlayed = parsed.gamesPlayed || 0;
                    winsCount = parsed.wins || 0;
                } catch(e) {}
            }
        }
        
        function saveStats() {
            const stats = {
                lossStreak,
                gamesPlayed,
                wins: winsCount,
                lastPlayed: new Date().toISOString()
            };
            localStorage.setItem('mines_stats', JSON.stringify(stats));
            profileWinsEl.textContent = winsCount;
        }
        
        function updateProfileInfo() {
            const username = localStorage.getItem('username') || '–ì–æ—Å—Ç—å';
            document.getElementById('profileUsername').textContent = username;
            document.getElementById('profileUserId').textContent = `ID: ${userId}`;
        }
        
        function createGrid() {
            minesGrid.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                cell.innerHTML = '<i class="fas fa-question"></i>';
                cell.addEventListener('click', () => cellClick(i));
                minesGrid.appendChild(cell);
            }
        }
        
        function updateBalanceDisplay() {
            const formatted = currentBalance.toLocaleString();
            balanceEl.textContent = formatted;
            profileBalanceEl.textContent = formatted + ' ‚ÇΩ';
            validateBet();
        }
        
        function updateCurrentSettings() {
            currentMinesEl.textContent = selectedMinesCount;
            currentBetEl.textContent = currentBetAmount.toLocaleString();
            if (!gameActive) {
                currentMultiplier = 1.0;
                currentMultiplierEl.textContent = '1.00x';
            }
        }
        
        function setupEventListeners() {
            betAmountInput.addEventListener('input', () => {
                currentBetAmount = parseInt(betAmountInput.value) || 0;
                validateBet();
                updateCurrentSettings();
            });
            
            document.querySelectorAll('.quick-amount').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (this.id === 'halfBalance') {
                        currentBetAmount = Math.floor(currentBalance / 2);
                    } else if (this.id === 'maxBalance') {
                        currentBetAmount = currentBalance;
                    } else {
                        currentBetAmount = parseInt(this.dataset.amount);
                    }
                    betAmountInput.value = currentBetAmount;
                    validateBet();
                    updateCurrentSettings();
                });
            });
            
            document.querySelectorAll('.mine-count-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (gameActive) return;
                    document.querySelectorAll('.mine-count-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMinesCount = parseInt(this.dataset.mines);
                    updateCurrentSettings();
                });
            });
            
            startButton.addEventListener('click', startGame);
            cashoutButton.addEventListener('click', cashout);
            
            document.getElementById('balanceChip').addEventListener('click', () => showDepositModal());
            document.getElementById('avatarBtn').addEventListener('click', toggleProfile);
            document.getElementById('menuOverlay').addEventListener('click', closeProfile);
        }
        
        function validateBet() {
            if (currentBetAmount < 1) currentBetAmount = 1;
            if (currentBetAmount > currentBalance) currentBetAmount = currentBalance;
            betAmountInput.value = currentBetAmount;
            
            const isValid = currentBetAmount > 0 && currentBetAmount <= currentBalance;
            startButton.disabled = !isValid || gameActive;
            cashoutButton.disabled = !gameActive;
            
            if (!isValid && !gameActive) {
                startButton.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –°–†–ï–î–°–¢–í';
            } else if (gameActive) {
                startButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ò–ì–†–ê –ò–î–Å–¢';
            } else {
                startButton.innerHTML = '<i class="fas fa-play"></i> –ù–ê–ß–ê–¢–¨';
            }
        }
        

        function generateMines() {
            gamesPlayed++;
            
            let mineProbability = selectedMinesCount / 25;
            if (lossStreak > 0) {
                mineProbability = Math.min(0.9, mineProbability + (lossStreak * 0.1));
            }
            
            const positions = [];
            while (positions.length < selectedMinesCount) {
                const pos = Math.floor(Math.random() * 25);
                if (!positions.includes(pos)) positions.push(pos);
            }
            
            return positions;
        }

        
        function startGame() {
            if (gameActive || currentBetAmount > currentBalance) return;
            
            currentBalance -= currentBetAmount;
            localStorage.setItem('user_balance', currentBalance);
            updateBalanceDisplay();
            
            gameActive = true;
            currentMultiplier = 1.0;
            revealedCells = [];
            minesPositions = generateMines();
            gameId = 'MINES_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            
            createGrid();
            startButton.disabled = true;
            cashoutButton.disabled = false;
            betAmountInput.disabled = true;
            
            document.querySelectorAll('.mine-count-btn').forEach(btn => {
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            updateMultiplierDisplay();
        }
        
        function updateMultiplierDisplay() {
            currentMultiplierEl.textContent = currentMultiplier.toFixed(2) + 'x';
            const potentialWin = Math.floor(currentBetAmount * currentMultiplier);
            cashoutButton.innerHTML = `<i class="fas fa-money-bill-wave"></i> –ó–ê–ë–†–ê–¢–¨ ${potentialWin.toLocaleString()}‚ÇΩ`;
        }
        
        function cellClick(index) {
            if (!gameActive || revealedCells.includes(index)) return;
            
            const cell = document.querySelector(`.cell[data-index="${index}"]`);
            
            if (minesPositions.includes(index)) {
                cell.classList.add('exploded');
                cell.innerHTML = '<i class="fas fa-bomb"></i>';
                
                revealAllMines();
                lossStreak++;
                endGame(false, 0);
            } else {
                cell.classList.add('revealed', 'gem');
                cell.innerHTML = '<i class="fas fa-gem"></i>';
                revealedCells.push(index);
                
                const bonus = cellBonusMultipliers[selectedMinesCount];
                currentMultiplier += bonus;
                
                const bonusIcon = document.createElement('div');
                bonusIcon.className = 'cell-bonus';
                bonusIcon.textContent = `+${bonus.toFixed(2)}x`;
                cell.appendChild(bonusIcon);
                
                setTimeout(() => {
                    if (bonusIcon.parentNode === cell) cell.removeChild(bonusIcon);
                }, 1500);
                
                updateMultiplierDisplay();
                
                const safeCells = 25 - selectedMinesCount;
                if (revealedCells.length === safeCells) {
                    cashout();
                }
            }
        }
        
        function revealAllMines() {
            minesPositions.forEach(index => {
                const cell = document.querySelector(`.cell[data-index="${index}"]`);
                if (!cell.classList.contains('revealed')) {
                    cell.classList.add('revealed', 'mine');
                    cell.innerHTML = '<i class="fas fa-bomb"></i>';
                }
            });
        }
        
        function cashout() {
            if (!gameActive) return;
            
            const winAmount = Math.floor(currentBetAmount * currentMultiplier);
            const profit = winAmount - currentBetAmount;
            
            currentBalance += winAmount;
            winsCount++;
            lossStreak = 0;
            
            localStorage.setItem('user_balance', currentBalance);
            localStorage.setItem('mines_wins', winsCount);
            updateBalanceDisplay();
            
            endGame(true, profit);
            showResultModal(true, profit, currentMultiplier);
            
            saveStats();
        }
        
        function endGame(isWin, profitAmount) {
            gameActive = false;
            
            startButton.disabled = false;
            cashoutButton.disabled = true;
            betAmountInput.disabled = false;
            
            document.querySelectorAll('.mine-count-btn').forEach(btn => {
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
            
            if (!isWin) {
                const loseAmount = currentBetAmount;
                addHistoryItem(false, loseAmount);
                saveGameToDB(false, 0, -loseAmount);
                showResultModal(false, loseAmount, null);
                saveStats();
            } else {
                addHistoryItem(true, profitAmount);
                saveGameToDB(true, profitAmount + currentBetAmount, profitAmount);
            }
            
            currentMultiplier = 1.0;
            updateMultiplierDisplay();
            validateBet();
        }
        
        function addHistoryItem(isWin, amount) {
            const item = document.createElement('div');
            item.className = `history-item ${isWin ? 'history-win' : 'history-lose'}`;
            
            if (isWin) {
                item.innerHTML = `<i class="fas fa-gem"></i> <span class="win-amount">+${amount.toLocaleString()}‚ÇΩ</span>`;
                item.title = `–í—ã–∏–≥—Ä—ã—à: +${amount.toLocaleString()}‚ÇΩ | –ú–∏–Ω: ${selectedMinesCount} | –Ø—á–µ–µ–∫: ${revealedCells.length}`;
            } else {
                item.innerHTML = `<i class="fas fa-bomb"></i> <span class="lose-amount">-${amount.toLocaleString()}‚ÇΩ</span>`;
                item.title = `–ü—Ä–æ–∏–≥—Ä—ã—à: -${amount.toLocaleString()}‚ÇΩ | –ú–∏–Ω: ${selectedMinesCount}`;
            }
            
            historyList.insertBefore(item, historyList.firstChild);
            if (historyList.children.length > 15) {
                historyList.removeChild(historyList.lastChild);
            }
            
            gameHistory.unshift({
                isWin,
                amount: isWin ? amount : -amount,
                mines: selectedMinesCount,
                cells: revealedCells.length,
                multiplier: currentMultiplier.toFixed(2),
                bet: currentBetAmount,
                timestamp: Date.now()
            });
            localStorage.setItem('mines_history', JSON.stringify(gameHistory.slice(0, 50)));
        }
        
        function loadHistory() {
            const saved = localStorage.getItem('mines_history');
            if (saved) {
                try {
                    gameHistory = JSON.parse(saved);
                    gameHistory.slice(0, 15).forEach(game => {
                        const item = document.createElement('div');
                        item.className = `history-item ${game.isWin ? 'history-win' : 'history-lose'}`;
                        if (game.isWin) {
                            item.innerHTML = `<i class="fas fa-gem"></i> <span class="win-amount">+${game.amount.toLocaleString()}‚ÇΩ</span>`;
                        } else {
                            item.innerHTML = `<i class="fas fa-bomb"></i> <span class="lose-amount">${game.amount.toLocaleString()}‚ÇΩ</span>`;
                        }
                        historyList.appendChild(item);
                    });
                } catch(e) {}
            }
        }
        
        async function saveGameToDB(isWin, winAmount, profit) {
            if (!userId) return;
            try {
                await supabaseClient.from('mines_history').insert({
                    id: gameId,
                    user_id: userId,
                    user_name: localStorage.getItem('username') || '–ò–≥—Ä–æ–∫',
                    bet_amount: currentBetAmount,
                    mines_count: selectedMinesCount,
                    is_win: isWin,
                    win_amount: winAmount,
                    profit: profit,
                    opened_cells: revealedCells.length,
                    multiplier: currentMultiplier.toFixed(2),
                    balance_after: currentBalance,
                    created_at: new Date().toISOString()
                });
            } catch(e) { console.error('DB error:', e); }
        }
        
     
        function showResultModal(isWin, amount, multiplier) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top:0; left:0; width:100%; height:100%;
                background: rgba(0,0,0,0.95); display:flex; justify-content:center;
                align-items:center; z-index:2000; backdrop-filter:blur(5px);
            `;
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius:20px; padding:30px; text-align:center; max-width:400px; width:90%; border:2px solid var(--border); box-shadow:0 20px 50px rgba(0,0,0,0.7);">
                    <div style="width:80px; height:80px; border-radius:50%; background:${isWin ? 'var(--gem-gradient)' : 'var(--mine-gradient)'}; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; font-size:36px; color:white;">
                        <i class="fas ${isWin ? 'fa-gem' : 'fa-bomb'}"></i>
                    </div>
                    <h2 style="font-size:24px; font-weight:900; margin-bottom:10px;">${isWin ? '–ü–û–ë–ï–î–ê!' : '–í–ó–†–´–í!'}</h2>
                    <p style="color:var(--text-secondary); margin-bottom:20px;">
                        ${isWin 
                            ? `–í—ã –æ—Ç–∫—Ä—ã–ª–∏ ${revealedCells.length} —è—á–µ–µ–∫ —Å –∞–ª–º–∞–∑–∞–º–∏!` 
                            : `–í—ã –Ω–∞—Å—Ç—É–ø–∏–ª–∏ –Ω–∞ –º–∏–Ω—É...`}
                    </p>
                    <div style="font-size:32px; font-weight:900; margin-bottom:25px; color:${isWin ? 'var(--success)' : 'var(--danger)'};">
                        ${isWin ? '+' : '-'}${Math.abs(amount).toLocaleString()} ‚ÇΩ
                    </div>
                    ${isWin ? `<p style="color:var(--text-secondary); margin-bottom:20px; font-size:14px;">–ú–Ω–æ–∂–∏—Ç–µ–ª—å: ${currentMultiplier.toFixed(2)}x</p>` : ''}
                    <button id="closeModal" style="width:100%; padding:16px; background:var(--gradient); border:none; border-radius:12px; color:white; font-weight:900; font-size:16px; cursor:pointer;">
                        ${isWin ? '–ò–ì–†–ê–¢–¨ –ï–©–Å' : '–ü–û–ü–†–û–ë–û–í–ê–¢–¨ –°–ù–û–í–ê'}
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('closeModal').onclick = () => modal.remove();
            setTimeout(() => modal.remove(), 5000);
        }
        
  
        let isProfileOpen = false;
        function toggleProfile() {
            const menu = document.getElementById('profileMenu');
            const overlay = document.getElementById('menuOverlay');
            isProfileOpen = !isProfileOpen;
            menu.classList.toggle('active', isProfileOpen);
            overlay.classList.toggle('active', isProfileOpen);
            updateProfileInfo();
            profileBalanceEl.textContent = currentBalance.toLocaleString() + ' ‚ÇΩ';
            profileWinsEl.textContent = winsCount;
        }
        function closeProfile() {
            document.getElementById('profileMenu').classList.remove('active');
            document.getElementById('menuOverlay').classList.remove('active');
            isProfileOpen = false;
        }
        
        function showDepositModal() {
            closeProfile();
            const isMobile = window.innerWidth <= 768;
            const modal = document.createElement('div');
            modal.style.cssText = `position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; justify-content:center; align-items:center; z-index:1002; backdrop-filter:blur(3px); padding:15px; overflow-y:auto;`;
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius:16px; padding:${isMobile?'20px':'25px'}; width:${isMobile?'95%':'380px'}; max-width:420px; border:1px solid var(--border); box-shadow:0 15px 40px rgba(0,0,0,0.5); position:relative; max-height:90vh; overflow-y:auto;">
                    <div style="position:absolute; top:${isMobile?'10px':'15px'}; right:${isMobile?'10px':'15px'}; color:var(--text-secondary); font-size:${isMobile?'20px':'22px'}; cursor:pointer; width:${isMobile?'32px':'36px'}; height:${isMobile?'32px':'36px'}; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,107,0,0.05);" id="closeDepModal">&times;</div>
                    <div style="text-align:center; margin-bottom:15px; padding-right:${isMobile?'25px':'30px'};">
                        <div style="width:${isMobile?'45px':'50px'}; height:${isMobile?'45px':'50px'}; background:var(--gradient); border-radius:${isMobile?'10px':'12px'}; display:flex; align-items:center; justify-content:center; margin:0 auto 10px; font-size:${isMobile?'18px':'20px'}; color:white;"><i class="fas fa-wallet"></i></div>
                        <h2 style="color:var(--text-primary); margin-bottom:5px; font-size:${isMobile?'18px':'20px'};">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –°–ë–ü</h2>
                        <p style="color:var(--text-secondary); font-size:${isMobile?'12px':'13px'};">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <span style="color:var(--primary); font-weight:700;" id="modalBalance">${currentBalance.toLocaleString()} ‚ÇΩ</span></p>
                    </div>
                    <div style="margin-bottom:15px;">
                        <div style="color:var(--text-secondary); margin-bottom:8px; font-size:${isMobile?'11px':'12px'}; font-weight:600;">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (‚ÇΩ)</div>
                        <input type="number" id="depositAmount" style="width:100%; padding:${isMobile?'12px':'14px'}; background:var(--bg-dark); border:1px solid var(--border); border-radius:${isMobile?'8px':'10px'}; color:var(--text-primary); font-size:${isMobile?'15px':'16px'}; outline:none; font-weight:600;" placeholder="1000" min="100" value="1000">
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(${isMobile?'2':'3'},1fr); gap:8px; margin-bottom:15px;">
                        <button class="quick-deposit" data-amount="500" style="padding:${isMobile?'10px 5px':'10px 5px'}; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-weight:600; cursor:pointer; font-size:${isMobile?'12px':'13px'};">500 ‚ÇΩ</button>
                        <button class="quick-deposit" data-amount="1000" style="padding:${isMobile?'10px 5px':'10px 5px'}; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-weight:600; cursor:pointer; font-size:${isMobile?'12px':'13px'};">1 000 ‚ÇΩ</button>
                        <button class="quick-deposit" data-amount="2000" style="padding:${isMobile?'10px 5px':'10px 5px'}; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-weight:600; cursor:pointer; font-size:${isMobile?'12px':'13px'};">2 000 ‚ÇΩ</button>
                        <button class="quick-deposit" data-amount="3000" style="padding:${isMobile?'10px 5px':'10px 5px'}; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-weight:600; cursor:pointer; font-size:${isMobile?'12px':'13px'};">3 000 ‚ÇΩ</button>
                        <button class="quick-deposit" data-amount="5000" style="padding:${isMobile?'10px 5px':'10px 5px'}; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-weight:600; cursor:pointer; font-size:${isMobile?'12px':'13px'};">5 000 ‚ÇΩ</button>
                        <button class="quick-deposit" data-amount="10000" style="padding:${isMobile?'10px 5px':'10px 5px'}; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-weight:600; cursor:pointer; font-size:${isMobile?'12px':'13px'};">10 000 ‚ÇΩ</button>
                    </div>
                    <button id="confirmDeposit" style="width:100%; padding:${isMobile?'14px':'15px'}; background:var(--gradient); border:none; border-radius:${isMobile?'8px':'10px'}; color:white; font-weight:800; font-size:${isMobile?'14px':'15px'}; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;"><i class="fas fa-arrow-right"></i> –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('#closeDepModal').onclick = () => modal.remove();
            modal.addEventListener('click', e => { if(e.target === modal) modal.remove(); });
            modal.querySelectorAll('.quick-deposit').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    modal.querySelector('#depositAmount').value = this.dataset.amount;
                });
            });
            modal.querySelector('#confirmDeposit').onclick = function(e) {
                e.stopPropagation();
                const amount = parseInt(modal.querySelector('#depositAmount').value);
                if(amount < 100) { alert('–ú–∏–Ω–∏–º—É–º 100 ‚ÇΩ'); return; }
                modal.remove();
                localStorage.setItem('sbp_amount', amount);
                window.location.href = 'sbp.html';
            };
        }
        
        function showWithdrawalModal() {
            closeProfile();
            alert('–í—ã–≤–æ–¥ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–∫–æ—Ä–æ –æ—Ç–∫—Ä–æ–µ–º!');
        }
        
        window.depositModal = showDepositModal;
        window.withdrawalModal = showWithdrawalModal;
        
        function goBack() {
            window.location.href = 'index.html';
        }
        
   
        document.addEventListener('DOMContentLoaded', function() {
            initGame();
            
            window.addEventListener('beforeunload', () => {
                localStorage.setItem('user_balance', currentBalance);
                saveStats();
            });
            
            window.addEventListener('focus', () => {
                const saved = localStorage.getItem('user_balance');
                if (saved && parseInt(saved) !== currentBalance) {
                    currentBalance = parseInt(saved);
                    updateBalanceDisplay();
                }
            });
        });
    </script>
</body>
</html>
